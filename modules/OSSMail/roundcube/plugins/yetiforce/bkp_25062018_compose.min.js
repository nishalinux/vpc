/* {[The file is published on the basis of YetiForce Public License that can be found in the following directory: licenses/License.html]} */

window.rcmail && rcmail.addEventListener('init', function (evt) {
	var crm = window.crm = getCrmWindow();
	var crmPath = rcmail.env.site_URL + 'index.php?';

	rcmail.env.compose_commands.push('yetiforce.addFilesToMail');
	rcmail.env.compose_commands.push('yetiforce.addFilesFromCRM');
	rcmail.env.compose_commands.push('yetiforce.SelectEmailTemplate');
	rcmail.env.compose_commands.push('yetiforce.SendEmailTemplate');
	rcmail.env.compose_commands.push('yetiforce.SendEmailTemplateClassic');

	// Document selection
	rcmail.register_command('yetiforce.addFilesToMail', function (data) {
		console.log('ids');
		var ts = new Date().getTime(),
				frame_name = 'rcmupload' + ts,
				frame = rcmail.async_upload_form_frame(frame_name);
		data._uploadid = ts;
		console.log('ids1');
		jQuery.ajax({
			url: "?_task=mail&_action=plugin.yetiforce.addFilesToMail&_id=" + rcmail.env.compose_id,
			type: "POST",
			data: data,
			success: function (data) {
				var doc = frame[0].contentWindow.document;
				//var body = jQuery('html', doc);
				var body = jQuery('head', doc);
				body.html(data);
			}
		});
	}, true);

	// Add a document to an email crm
	rcmail.register_command('yetiforce.addFilesFromCRM', function (data) {
		if (crm != false) {
			var params = {
				module: 'Documents',
				src_module: 'Documents',
				multi_select: true,
				url: crmPath
			};
			var sourceFieldElement = $(this);
			var prePopupOpenEvent = jQuery.Event(crm.Vtiger_Edit_Js.preReferencePopUpOpenEvent);
			sourceFieldElement.trigger(prePopupOpenEvent);
			var data = {};
			show(params, function (data) {
				var responseData = JSON.parse(data);
				var ids = [];
				for (var id in responseData) {
					ids.push(id);
				}
				rcmail.command('yetiforce.addFilesToMail', {ids: ids, _uploadid: new Date().getTime()});
			});
		}
	}, true);












	//TO field not allow to type
	$("#_to").keypress(function(e){
		if( e.keyCode === 8 || e.keyCode === 46 ) {
			return; // backspace (8) / delete (46)
		}
		else{
			//alert('Key pressed');
			return false;
		}
		e.preventDefault( );
		
	});
	
	//CC field not allow to type
	$("#_cc").keypress(function(e){
		if( e.keyCode === 8 || e.keyCode === 46 ) {
			return; // backspace (8) / delete (46)
		}
		else{
			//alert('Key pressed');
			return false;
		}
		e.preventDefault( );
		
	});

	//BCC field not allow to type
	$("#_bcc").keypress(function(e){
		if( e.keyCode === 8 || e.keyCode === 46 ) {
			return; // backspace (8) / delete (46)
		}
		else{
			//alert('Key pressed');
			return false;
		}
		e.preventDefault( );
		
	});




		


/*
	function getCookie(cname) {
		var name = cname + "=";
		var decodedCookie = decodeURIComponent(document.cookie);
		var ca = decodedCookie.split(';');
		for(var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}
	*/
	
	
	
	// Selection of email with popup for larry
	$('#composeheaders #oss_btn_bar .oss_btn').click(function () {
		var mailField = $(this).attr('data-input');
		var module = $(this).attr('data-module');
		var selectedcontact = $("#selectedcontact").val();
		var params = {
			module: module,
			src_module: 'OSSMail',
			multi_select: true,
			url: crmPath
		};
		show(params, function (data) {
			var responseData = JSON.parse(data);
			var length = Object.keys(responseData).length;
			for (var id in responseData) 
				{
				console.log('on select ');
				console.log(responseData);
				if(selectedcontact == 0){
					selectedcontact = id;
				}
				else{
					selectedcontact = selectedcontact+','+id;
				}
				getMailFromCRM(mailField, module, id, length);
			}
			$("#selectedcontact").val(selectedcontact);
		});
	});

		// Selection of email with popup Ganesh added on 28 MAy 2018 for Classic
		$('#compose-headers-div #oss_btn_bar .oss_btn').click(function () {
			var mailField = $(this).attr('data-input');
			var module = $(this).attr('data-module');
			var selectedcontact = $("#selectedcontact").val();
			var params = {
				module: module,
				src_module: 'OSSMail',
				multi_select: true,
				url: crmPath
			};
			show(params, function (data) {
				var responseData = JSON.parse(data);
				var length = Object.keys(responseData).length;
				for (var id in responseData) 
					{
					console.log('on select ');
					console.log(responseData);
					if(selectedcontact == 0){
						selectedcontact = id;
					}
					else{
						selectedcontact = selectedcontact+','+id;
					}
					getMailFromCRM(mailField, module, id, length);
				}
				$("#selectedcontact").val(selectedcontact);
			});
		});

	//Loading list of modules with templates mail
	jQuery.ajax({
		type: 'Get',
		url: crmPath + 'module=OSSMailTemplates&action=GetTemplates',
		async: false,
		success: function (data) {
			var modules = [];
			var tmp = [];
			$.each(data.result, function (index, value) {
				jQuery('#vtmodulemenulink').removeClass('disabled');
				jQuery('#tplmenulink').removeClass('disabled');
				tmp.push({name: value.module, label: value.moduleName});
				jQuery('#tplmenu #texttplsmenu').append('<li class="' + value.module + '"><a href="#" data-module="' + value.module + '" data-tplid="' + value.id + '" class="active">' + value.name + '</a></li>');
			});

			$.each(tmp, function (index, value) {
				if (jQuery.inArray(value.name, modules) == -1) {
					jQuery('#vtmodulemenu .toolbarmenu').append('<li class="' + value.name + '"><a href="#" data-module="' + value.name + '" class="active">' + value.label + '</a></li>');
					modules.push(value.name);
				}
			});

		}
	});

	// Limit the list of templates
	jQuery('#vtmodulemenu li a').on('click', function () {
		var selectModule = jQuery(this).data('module');
		if (selectModule == undefined) {
			jQuery('#tplmenu li').show();
		} else {
			jQuery('#tplmenu li.' + selectModule).show();
			jQuery('#tplmenu li').not("." + selectModule).hide();
		}
	});

	if (rcmail.env.crmModule != undefined) {
		jQuery('#vtmodulemenu li.' + rcmail.env.crmModule + ' a').trigger("click");
	}

	// Loading a template mail
	jQuery('#tplmenu  li a').on('click', function () {
		var id = jQuery(this).data('tplid');
		var recordId = rcmail.env.crmRecord,
				module = rcmail.env.crmModule,
				view = rcmail.env.crmView;
		if (view == 'List') {
			var chElement = jQuery(crm.document).find('.listViewEntriesCheckBox')[0];
			recordId = jQuery(chElement).val();
		}
		jQuery.ajax({
			type: 'Get',
			url: crmPath + 'module=OSSMailTemplates&action=GetTpl',
			data: {
				id: id,
				record_id: recordId,
				select_module: module
			},
			success: function (data) {
				var oldSubject = jQuery('[name="_subject"]').val();
				var html = jQuery("<div/>").html(data.result['content']).html();
				jQuery('[name="_subject"]').val(oldSubject + ' ' + data.result['subject']);
				if (window.tinyMCE && (ed = tinyMCE.get(rcmail.env.composebody))) {
					var oldBody = tinyMCE.activeEditor.getContent();
					tinymce.activeEditor.setContent(html + oldBody);
				} else {
					var oldBody = jQuery('#composebody').val();
					jQuery('#composebody').val(html + oldBody);
				}
				if (data.result.hasOwnProperty("attachments")) {
					rcmail.command('yetiforce.addFilesToMail', data.result.attachments);
				}
			}
		});
	});











// Ganesh on 13 June 2018 for Select Email Template
rcmail.register_command('yetiforce.SelectEmailTemplate', function (e) {
	var sourceFieldElement = $(this);
	if (crm != false) {
		var params = {
			module: 'EmailTemplates',
			parent: 'Settings',
			view: 'List',
			url: crmPath
		};
		var sourceFieldElement = $(this);
		var prePopupOpenEvent = jQuery.Event(crm.Vtiger_Edit_Js.preReferencePopUpOpenEvent);
		sourceFieldElement.trigger(prePopupOpenEvent);
		var data = {};

		show(params, function (data) {
			var responseData = JSON.parse(data);
			var ids = [];
			for (var id in responseData) {
				var selectedName = responseData[id].name;
				var selectedTemplateBody = responseData[id].info;
				var mailtempid = id;
			}
			var useremail = $(".username").text();
			if(useremail == ''){
				useremail = $('#_from').find(":selected").text();;
			}
			//_from$('#_from').find(":selected").text();
			$.ajax({
				url: crmPath+"module=OSSMail&view=GetSignature&useremail="+useremail, 
				success: function(result){
					$("input[name='_subject']").val(selectedName);
					var sign =result;		
					sign = $("<div />").html(sign).text();
				var mail_content = '<div id="_rc_sig">--<br>'+sign+'</div>';
					$("#composebody_ifr").contents().find('#tinymce').html(selectedTemplateBody);
					$("#composebody_ifr").contents().find('#tinymce').append(mail_content);
					$("#composebody_ifr").contents().find('#tinymce').attr('disabled', true);
					//compose-body_ifr
					$("#compose-body_ifr").contents().find('#tinymce').html(selectedTemplateBody);
					$("#compose-body_ifr").contents().find('#tinymce').append(mail_content);
					$("#compose-body_ifr").contents().find('#tinymce').attr('disabled', true);
					$("#mailtempid").val(mailtempid);
				}
			});
			$.ajax({				
				url: crmPath+"module=OSSMail&view=getLogo", 
				success: function(resultimg){
					$("#imagsrc").val(resultimg);
				}
			});
			
		});
	}

}, true);
/*
$.ajax({				
	url: crmPath+"module=OSSMail&view=getLogo", 
	success: function(resultimg){
		$("#imagsrc").val(resultimg);
	}
});
*/

	rcmail.register_command('yetiforce.SendEmailTemplate', function (event) {
		var mailtempid = $("#mailtempid").val();
		var useremail = $(".username").text();
		if(useremail == ''){
			useremail = $('#_from').find(":selected").text();;
		}
		var selectedcontact =  $("#selectedcontact").val();
		var tomail = $("#_to").val();
		var subject = $("input[name='_subject']").val();
		//alert(tomail);
		var arrtomail = tomail.split(',');
		var arrselectedcontact = selectedcontact.split(',');
		var token = $("input[name='_token']").val();
		var task = 'mail';
		var action = "send";
		var id = $("input[name='_id']").val();
		var from = $("#_from").val();
		var attachments = $("input[name='_attachments']").val();
		//var from = useremail;
		
		//alert(dNow);
		var imagsrc = $("#imagsrc").val();
		var cc = $("#_cc").val();
		var bcc = $("#_bcc").val();
		var replyto = $("#_replyto").val();
		var followupto = $("#_followupto").val();
		var editorSelector = $("[name='editorSelector']").val();
		var priority = $("[name='_priority']").val();
		var store_target = "Sent";
		if(editorSelector == 'html'){
			var is_html = 1;
		}
		else{
			var is_html = 0;
		}
		
		var framed= 1;
		//alert(arrtomail);
		var i,j;
		
		
		if(mailtempid > 0){
			if(arrtomail.length>1){
				for(i=0;i<arrtomail.length;i++){
					var toml = arrtomail[i];
					myajx(toml,i,imagsrc);
					
				}


				function myajx(toml,i,imagsrc){
					console.log(imagsrc);	
					$.ajax({	
								
						url: crmPath+"module=OSSMail&view=getMailTemplate&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&useremail="+useremail+"&tomail="+toml, 
						success: function(geresult){							
							conten = $("<div />").html(geresult).text();
							conten = conten.replace("$logo$", imagsrc);
							$("#composebody_ifr").contents().find('#tinymce').html(conten);
							console.log(conten);
							var mess = $("#composebody_ifr").contents().find('#tinymce').text();
							//compose-body_ifr
							if(i < arrtomail.length-1){
								
							var nextdata = "_token="+token+"&_task="+task+"&_action="+action+"&_id="+id+"&_attachments="+attachments+"&_from="+from+"&_to="+toml+"&_cc="+cc+"&_bcc="+bcc+"&_replyto="+replyto+"&_followupto="+followupto+"&_subject="+subject+"&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&editorSelector="+editorSelector+"&_priority="+priority+"&_store_target="+store_target+"&_draft_saveid=&_draft=&_is_html="+is_html+"&_framed="+framed+"&_message="+conten;
							var dNow = new Date().getTime();
							$.ajax({
								type:"POST",
								dataType: "text",
								data: nextdata,
								url:rcmail.env.site_URL+"modules/OSSMail/roundcube/?_task=mail&_unlock=loading"+dNow+"&_framed=1",
								success: function(result){
									
									
								}
							});
						}else{
							$("#_to").val(toml);
							return rcmail.command('send','',this,event);
						}
						}
					});
				}

			}
			else{
				for(i=0;i<arrtomail.length;i++){
					//alert(arrtomail.length);
					var tom = arrtomail[i];
					$.ajax({					
						url: crmPath+"module=OSSMail&view=getMailTemplate&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&useremail="+useremail+"&tomail="+tom, 
						success: function(result){
							conten = $("<div />").html(result).text();
						//var mail_content = '<div id="_rc_sig">--<br>'+sign+'</div>';
						conten = conten.replace("$logo$", imagsrc);
							$("#composebody_ifr").contents().find('#tinymce').html(conten);
							//compose-body_ifr
							$("#_to").val(tom);
							//$("#composebody_ifr").contents().find('#tinymce').append(mail_content);
							return rcmail.command('send','',this,event);
						}
					});
				}
			}
			
			
		}
		else{
			return rcmail.command('send','',this,event);
		}
		
	}, true);










	rcmail.register_command('yetiforce.SendEmailTemplateClassic', function (event) {
		var mailtempid = $("#mailtempid").val();
		var useremail = $(".username").text();
		if(useremail == ''){
			useremail = $('#_from').find(":selected").text();;
		}
		var selectedcontact =  $("#selectedcontact").val();
		var tomail = $("#_to").val();
		var subject = $("input[name='_subject']").val();
		//alert(tomail);
		var arrtomail = tomail.split(',');
		var arrselectedcontact = selectedcontact.split(',');
		var token = $("input[name='_token']").val();
		var task = 'mail';
		var action = "send";
		var id = $("input[name='_id']").val();
		var from = $("#_from").val();
		var attachments = $("input[name='_attachments']").val();
		//var from = useremail;
		
		//alert(dNow);
		var imagsrc = $("#imagsrc").val();
		var cc = $("#_cc").val();
		var bcc = $("#_bcc").val();
		var replyto = $("#_replyto").val();
		var followupto = $("#_followupto").val();
		var editorSelector = $("[name='editorSelector']").val();
		var priority = $("[name='_priority']").val();
		var store_target = "Sent";
		if(editorSelector == 'html'){
			var is_html = 1;
		}
		else{
			var is_html = 0;
		}
		
		var framed= 1;
		//alert(arrtomail);
		var i,j;
		
		
		if(mailtempid > 0){
			if(arrtomail.length>1){
				for(i=0;i<arrtomail.length;i++){
					var toml = arrtomail[i];
					classicyajx(toml,i,imagsrc);
					
				}


				function classicyajx(toml,i,imagsrc){
					console.log(imagsrc);	
					$.ajax({	
								
						url: crmPath+"module=OSSMail&view=getMailTemplate&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&useremail="+useremail+"&tomail="+toml, 
						success: function(geresult){							
							conten = $("<div />").html(geresult).text();
							conten = conten.replace("$logo$", imagsrc);
							$("#composebody_ifr").contents().find('#tinymce').html(conten);
							console.log(conten);
							var mess = $("#compose-body_ifr").contents().find('#tinymce').text();
							if(i < arrtomail.length-1){
								
							var nextdata = "_token="+token+"&_task="+task+"&_action="+action+"&_id="+id+"&_attachments="+attachments+"&_from="+from+"&_to="+toml+"&_cc="+cc+"&_bcc="+bcc+"&_replyto="+replyto+"&_followupto="+followupto+"&_subject="+subject+"&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&editorSelector="+editorSelector+"&_priority="+priority+"&_store_target="+store_target+"&_draft_saveid=&_draft=&_is_html="+is_html+"&_framed="+framed+"&_message="+conten;
							var dNow = new Date().getTime();
							$.ajax({
								type:"POST",
								dataType: "text",
								data: nextdata,
								url:rcmail.env.site_URL+"modules/OSSMail/roundcube/?_task=mail&_unlock=loading"+dNow+"&_framed=1",
								success: function(result){
									
									
								}
							});
						}else{
							$("#_to").val(toml);
							return rcmail.command('send','',this,event);
						}
						}
					});
				}

			}
			else{
				for(i=0;i<arrtomail.length;i++){
					//alert(arrtomail.length);
					var tom = arrtomail[i];
					$.ajax({					
						url: crmPath+"module=OSSMail&view=getMailTemplate&mailtempid="+mailtempid+"&selectedcontact="+selectedcontact+"&useremail="+useremail+"&tomail="+tom, 
						success: function(result){
							conten = $("<div />").html(result).text();
						//var mail_content = '<div id="_rc_sig">--<br>'+sign+'</div>';
						conten = conten.replace("$logo$", imagsrc);
							$("#compose-body_ifr").contents().find('#tinymce').html(conten);
							//compose-body_ifr
							$("#_to").val(tom);
							//$("#composebody_ifr").contents().find('#tinymce').append(mail_content);
							return rcmail.command('send','',this,event);
						}
					});
				}
			}
			
			
		}
		else{
			return rcmail.command('send','',this,event);
		}
		
	}, true);






	//$("#_to").val(myto);
	
	var myto = getQueryVariable("sourceRecord");
	if(myto != false){
		var mymodul = getQueryVariable("sourceModule");
		if(mymodul != false || mymodul != ''){
			var mydata = "id="+myto+"&source="+mymodul;
		}
		else{
			var mydata = "id="+myto+"&source=Accounts";
		}
		$.ajax({
			url: crmPath+"&module=OSSMail&view=sendusermail&"+mydata, 
			success: function(result){
				$("#_to").val(result);
			}
		});
	}
	
});




	function getQueryVariable(variable)
	{
		var query =  window.frameElement.src.substring(1);
		var vars = query.split("&");
		for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == variable){return pair[1];}
		}
		return(false);
	}
	





function getCrmWindow() {
	if (opener !== null) {
		return opener.parent;
	} else if (typeof parent.app == "object") {
		return parent;
	}
	return false;
}

function getMailFromCRM(mailField, module, record, length) {
	if (length > 1) {
		length = 1;
	} else {
		length = 0;
	}
	console.log('getMailFromCRM------------------------------');
	console.log(mailField);
	console.log(module);
	console.log(length);
	window.crm.Vtiger_Index_Js.getEmailFromRecord(record, module, length).then(function (data) {
		if (data == '') {
			var notifyParams = {
				text: window.crm.app.vtranslate('NoFindEmailInRecord'),
				animation: 'show'
			};
							console.log('getMailFromCRM----------------if--------------');

			window.crm.Vtiger_Helper_Js.showPnotify(notifyParams);
		} else {
			console.log('else');
			console.log($('#' + mailField).val());
			var emails = $('#' + mailField).val();
			if (emails != '' && emails.charAt(emails.length - 1) != ',') {
				emails = emails + ',';
			}
			$('#' + mailField).val(emails + data);
				console.log('getMailFromCRM----------------else--------------');

		}
	});
}
function show(urlOrParams, cb, windowName, eventName, onLoadCb) {
	var thisInstance = window.crm.Vtiger_Popup_Js.getInstance();
	if (typeof urlOrParams == 'undefined') {
		urlOrParams = {};
	}
	if (typeof urlOrParams == 'object' && (typeof urlOrParams['view'] == "undefined")) {
		urlOrParams['view'] = 'Popup';
	}
	if (typeof eventName == 'undefined') {
		eventName = 'postSelection' + Math.floor(Math.random() * 10000);
	}
	if (typeof windowName == 'undefined') {
		windowName = 'test';
	}
	if (typeof urlOrParams == 'object') {
		urlOrParams['triggerEventName'] = eventName;
	} else {
		urlOrParams += '&triggerEventName=' + eventName;
	}
	var urlString = (typeof urlOrParams == 'string') ? urlOrParams : window.crm.jQuery.param(urlOrParams);
	var url = urlOrParams['url'] + urlString;
	var popupWinRef = window.crm.window.open(url, windowName, 'width=800,height=650,resizable=0,scrollbars=1');
	if (typeof thisInstance.destroy == 'function') {
		thisInstance.destroy();
	}
	window.crm.jQuery.initWindowMsg();
	if (typeof cb != 'undefined') {
		thisInstance.retrieveSelectedRecords(cb, eventName);
	}
	if (typeof onLoadCb == 'function') {
		window.crm.jQuery.windowMsg('Vtiger.OnPopupWindowLoad.Event', function (data) {
			onLoadCb(data);
		})
	}
	return popupWinRef;
}

